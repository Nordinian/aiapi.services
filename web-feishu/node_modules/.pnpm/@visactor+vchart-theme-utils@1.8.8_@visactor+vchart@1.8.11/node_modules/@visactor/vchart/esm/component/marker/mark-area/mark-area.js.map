{"version":3,"sources":["../src/component/marker/mark-area/mark-area.ts"],"names":[],"mappings":"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","file":"mark-area.js","sourcesContent":["import { DataView } from '@visactor/vdataset';\nimport type { IMarkArea, IMarkAreaSpec } from './interface';\nimport { ComponentTypeEnum } from '../../interface/type';\nimport type { IOptionAggr } from '../../../data/transforms/aggregation';\n// eslint-disable-next-line no-duplicate-imports\nimport { markerAggregation } from '../../../data/transforms/aggregation';\nimport { computeClipRange, coordinateLayout, positionLayout, xyLayout, transformLabelAttributes } from '../utils';\nimport { registerDataSetInstanceTransform } from '../../../data/register';\nimport type { MarkAreaAttrs } from '@visactor/vrender-components';\nimport { MarkArea as MarkAreaComponent } from '@visactor/vrender-components';\nimport type { Maybe } from '@visactor/vutils';\n// eslint-disable-next-line no-duplicate-imports\nimport { isEmpty, isValid, isArray } from '@visactor/vutils';\nimport { transformToGraphic } from '../../../util/style';\nimport { BaseMarker } from '../base-marker';\nimport { LayoutZIndex } from '../../../constant';\nimport type { IGroup } from '@visactor/vrender-core';\nimport { Factory } from '../../../core/factory';\nimport type { IPoint } from '../../../typings';\nimport type { IModelSpecInfo } from '../../../model/interface';\nimport { markerFilter } from '../../../data/transforms/marker-filter';\n\nexport class MarkArea extends BaseMarker<IMarkAreaSpec> implements IMarkArea {\n  static type = ComponentTypeEnum.markArea;\n  type = ComponentTypeEnum.markArea;\n  name: string = ComponentTypeEnum.markArea;\n\n  static specKey = 'markArea';\n  specKey = 'markArea';\n\n  layoutZIndex: number = LayoutZIndex.MarkArea;\n\n  // markArea组件\n  protected declare _markerComponent: MarkAreaComponent;\n\n  static getSpecInfo(chartSpec: any): Maybe<IModelSpecInfo[]> {\n    const markAreaSpec = chartSpec[this.specKey];\n    if (isEmpty(markAreaSpec)) {\n      return undefined;\n    }\n    if (!isArray(markAreaSpec) && markAreaSpec.visible !== false) {\n      return [\n        {\n          spec: markAreaSpec,\n          specPath: [this.specKey],\n          type: ComponentTypeEnum.markArea\n        }\n      ];\n    }\n    const specInfos: IModelSpecInfo[] = [];\n    markAreaSpec.forEach((m: any, i: number) => {\n      if (m.visible !== false) {\n        specInfos.push({\n          spec: m,\n          specIndex: i,\n          specPath: [this.specKey, i],\n          type: ComponentTypeEnum.markArea\n        });\n      }\n    });\n    return specInfos;\n  }\n\n  protected _createMarkerComponent() {\n    const label = this._spec.label ?? {};\n    const markAreaAttrs: MarkAreaAttrs = {\n      zIndex: this.layoutZIndex,\n      interactive: this._spec.interactive ?? false,\n      points: [\n        {\n          x: 0,\n          y: 0\n        }\n      ],\n      areaStyle: transformToGraphic(this._spec.area?.style),\n      clipInRange: this._spec.clip ?? false,\n      label: transformLabelAttributes(label)\n    };\n\n    const markArea = new MarkAreaComponent(markAreaAttrs);\n    return markArea as unknown as IGroup;\n  }\n\n  protected _markerLayout() {\n    const spec = this._spec as any;\n    const data = this._markerData;\n    const startRelativeSeries = this._startRelativeSeries;\n    const endRelativeSeries = this._endRelativeSeries;\n    const relativeSeries = this._relativeSeries;\n\n    const isXLayout = isValid(spec.x) && isValid(spec.x1);\n    const isYLayout = isValid(spec.y) && isValid(spec.y1);\n    const isXYLayout = isXLayout && isYLayout;\n    const isCoordinateLayout = isValid(spec.coordinates);\n    const isPositionLayout = isValid(spec.positions);\n    const autoRange = spec.autoRange ?? false;\n\n    let points: IPoint[] = [];\n    let lines: IPoint[][] = [];\n    if (isXYLayout) {\n      lines = xyLayout(data, startRelativeSeries, endRelativeSeries, relativeSeries, autoRange);\n      // 格式为 [[{x, y}], [{x, y}]]\n      // 顺序为左小角开始逆时针绘制\n      points = [\n        {\n          x: lines[0][0].x,\n          y: lines[1][0].y\n        },\n        lines[0][0],\n        {\n          x: lines[1][0].x,\n          y: lines[0][0].y\n        },\n        lines[1][0]\n      ];\n    } else if (isXLayout || isYLayout) {\n      lines = xyLayout(data, startRelativeSeries, endRelativeSeries, relativeSeries, autoRange);\n      points = [...lines[0], lines[1][1], lines[1][0]];\n    } else if (isCoordinateLayout) {\n      points = coordinateLayout(data, relativeSeries, autoRange, spec.coordinatesOffset);\n    } else if (isPositionLayout) {\n      points = positionLayout(spec.positions, relativeSeries, spec.regionRelative);\n    }\n\n    const seriesData = this._relativeSeries.getViewData().latestData;\n    const dataPoints = data\n      ? data.latestData[0] && data.latestData[0].latestData\n        ? data.latestData[0].latestData\n        : data.latestData\n      : seriesData;\n\n    let limitRect;\n    if (spec.clip || spec.label?.confine) {\n      const { minX, maxX, minY, maxY } = computeClipRange([\n        startRelativeSeries.getRegion(),\n        endRelativeSeries.getRegion(),\n        relativeSeries.getRegion()\n      ]);\n      limitRect = {\n        x: minX,\n        y: minY,\n        width: maxX - minX,\n        height: maxY - minY\n      };\n    }\n\n    if (this._markerComponent) {\n      this._markerComponent.setAttributes({\n        points: points,\n        label: {\n          ...this._markerComponent.attribute?.label,\n          text: this._spec.label.formatMethod\n            ? this._spec.label.formatMethod(dataPoints, seriesData)\n            : this._markerComponent.attribute?.label?.text\n        },\n        limitRect,\n        dx: this._layoutOffsetX,\n        dy: this._layoutOffsetY\n      });\n    }\n  }\n\n  protected _initDataView(): void {\n    const spec = this._spec as any;\n    const relativeSeries = this._relativeSeries;\n    const isXProcess = isValid(spec.x) && isValid(spec.x1);\n    const isYProcess = isValid(spec.y) && isValid(spec.y1);\n    const isXYProcess = isXProcess && isYProcess;\n    const isCoordinateProcess = isValid(spec.coordinates);\n    if (!isXProcess && !isYProcess && !isCoordinateProcess) {\n      return null;\n    }\n    let options: IOptionAggr[];\n    if (isXYProcess) {\n      options = [this._processSpecXY(spec.x, spec.y), this._processSpecXY(spec.x1, spec.y1)];\n    } else if (isXProcess) {\n      options = [this._processSpecX(spec.x), this._processSpecX(spec.x1)];\n    } else if (isYProcess) {\n      options = [this._processSpecY(spec.y), this._processSpecY(spec.y1)];\n    } else if (isCoordinateProcess) {\n      options = this._processSpecCoo(spec);\n    }\n\n    const seriesData = relativeSeries.getViewData();\n    registerDataSetInstanceTransform(this._option.dataSet, 'markerAggregation', markerAggregation);\n    registerDataSetInstanceTransform(this._option.dataSet, 'markerFilter', markerFilter);\n    const data = new DataView(this._option.dataSet, { name: `${this.type}_${this.id}_data` });\n    data.parse([seriesData], {\n      type: 'dataview'\n    });\n    data.transform({\n      type: 'markerAggregation',\n      options\n    });\n\n    if (options) {\n      data.transform({\n        type: 'markerFilter',\n        options: this._getAllRelativeSeries()\n      });\n    }\n\n    data.target.on('change', () => {\n      this._markerLayout();\n    });\n    this._markerData = data;\n  }\n}\n\nexport const registerMarkArea = () => {\n  Factory.registerComponent(MarkArea.type, MarkArea);\n};\n"]}