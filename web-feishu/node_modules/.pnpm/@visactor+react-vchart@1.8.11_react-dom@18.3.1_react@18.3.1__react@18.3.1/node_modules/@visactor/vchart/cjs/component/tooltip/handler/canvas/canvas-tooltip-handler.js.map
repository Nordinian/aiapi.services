{"version":3,"sources":["../src/component/tooltip/handler/canvas/canvas-tooltip-handler.ts"],"names":[],"mappings":"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","file":"canvas-tooltip-handler.js","sourcesContent":["import type { ILayer, INode, Stage } from '@visactor/vrender-core';\nimport type { IToolTipActual } from '../../../../typings/tooltip';\nimport type { TooltipHandlerParams } from '../../interface';\nimport { BaseTooltipHandler } from '../base';\nimport { Tooltip as TooltipComponent } from '@visactor/vrender-components';\nimport { isValid } from '@visactor/vutils';\nimport { TooltipHandlerType } from '../constants';\nimport type { Tooltip } from '../../tooltip';\n\n/**\n * The tooltip handler class.\n */\nexport class CanvasTooltipHandler extends BaseTooltipHandler {\n  type = TooltipHandlerType.canvas;\n\n  private _layer: ILayer;\n  protected _el?: HTMLCanvasElement;\n  protected _tooltipCanvasId?: string;\n  protected _tooltipComponent: TooltipComponent;\n\n  constructor(tooltipId: string, component: Tooltip) {\n    super(tooltipId, component);\n    this._tooltipCanvasId = (this._chartOption.modeParams as any)?.tooltipCanvasId;\n  }\n\n  private _initTooltipComponent(stage: Stage) {\n    const layer = this._getLayer(stage);\n    this._tooltipComponent = new TooltipComponent({\n      autoCalculatePosition: false,\n      autoMeasure: false\n    });\n    layer.add(this._tooltipComponent as unknown as INode);\n  }\n\n  private _getLayer(stage: Stage) {\n    if (this._layer) {\n      return this._layer;\n    }\n\n    this._layer = stage.createLayer(this._tooltipCanvasId);\n\n    // 需要关闭 layer 对应的 canvas 的事件\n    const layerCanvas = this._layer.layerHandler.canvas.nativeCanvas as HTMLCanvasElement;\n    // TODO：待 vrender 支持\n    if (layerCanvas && layerCanvas.style) {\n      layerCanvas.style.touchAction = 'none';\n      layerCanvas.style.pointerEvents = 'none';\n    }\n\n    return this._layer;\n  }\n\n  protected _removeTooltip() {\n    if (this._layer) {\n      this._layer.removeAllChild();\n      // this._layer.render();\n    }\n    this._attributes = null;\n  }\n\n  protected _updateTooltip(visible: boolean, params: TooltipHandlerParams, actualTooltip: IToolTipActual) {\n    this._visible = visible;\n\n    const stage = this._compiler.getStage();\n    if (!stage) {\n      return;\n    }\n\n    if (!visible) {\n      if (this._tooltipComponent && this._tooltipComponent.attribute.visible) {\n        this._tooltipComponent.hideAll();\n        this._tooltipComponent.setAttributes({\n          visibleAll: false\n        });\n      }\n      return;\n    }\n\n    if (!this._tooltipComponent) {\n      this._initTooltipComponent(stage);\n    }\n\n    const pos = actualTooltip?.position;\n    if (!params.changePositionOnly) {\n      this._tooltipComponent.setAttributes({\n        ...this._attributes,\n        ...pos\n      });\n    } else if (isValid(pos)) {\n      this._tooltipComponent.setAttributes(pos);\n    }\n\n    if (!this._tooltipComponent.attribute.visible) {\n      this._tooltipComponent.showAll();\n      this._tooltipComponent.setAttributes({\n        visibleAll: true\n      });\n    }\n  }\n\n  isTooltipShown() {\n    return this._tooltipComponent?.attribute.visibleAll;\n  }\n\n  release() {\n    super.release();\n    this._layer?.release();\n  }\n}\n"]}