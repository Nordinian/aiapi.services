{"version":3,"sources":["../src/compile/compiler.ts"],"names":[],"mappings":"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","file":"compiler.js","sourcesContent":["import { ChartEvent } from './../constant/event';\nimport type { IElement, IView } from '@visactor/vgrammar-core';\n// eslint-disable-next-line no-duplicate-imports\nimport { View } from '@visactor/vgrammar-core';\nimport type {\n  CompilerListenerParameters,\n  CompilerModel,\n  IGrammarItem,\n  IProductMap,\n  IRenderContainer,\n  IRenderOption\n} from './interface';\n// eslint-disable-next-line no-duplicate-imports\nimport { GrammarType } from './interface/compilable-item';\nimport { toRenderMode } from './util';\nimport { isMobileLikeMode, isTrueBrowser } from '../util/env';\nimport { isString } from '../util/type';\nimport type { IBoundsLike } from '@visactor/vutils';\n// eslint-disable-next-line no-duplicate-imports\nimport { isNil, isValid, Logger, LoggerLevel } from '@visactor/vutils';\nimport type { EventSourceType } from '../event/interface';\nimport type { IChart } from '../chart/interface';\nimport type { VChart } from '../core/vchart';\nimport type { IColor, Stage } from '@visactor/vrender-core';\nimport type { IMorphConfig } from '../animation/spec';\nimport { Event_Source_Type } from '../constant';\n\ntype EventListener = {\n  type: string;\n  callback: (...args: any[]) => void;\n};\n\nexport class Compiler {\n  protected _view: IView;\n  /**\n   * 获取 VGrammar View 实例\n   */\n  getVGrammarView() {\n    return this._view;\n  }\n  protected _viewListeners: Map<(...args: any[]) => any, EventListener> = new Map();\n  protected _windowListeners: Map<(...args: any[]) => any, EventListener> = new Map();\n  protected _canvasListeners: Map<(...args: any[]) => any, EventListener> = new Map();\n\n  isInited: boolean = false;\n  // 是否已经销毁\n  isReleased: boolean = false;\n\n  protected _width: number;\n  protected _height: number;\n\n  protected _container: IRenderContainer;\n  protected _option: IRenderOption;\n\n  protected _model: CompilerModel = {\n    [GrammarType.signal]: {},\n    [GrammarType.data]: {},\n    [GrammarType.mark]: {}\n  };\n  getModel() {\n    return this._model;\n  }\n\n  private _compileChart: IChart = null;\n\n  constructor(container: IRenderContainer, option: IRenderOption) {\n    this._container = container;\n    this._option = option;\n  }\n\n  getRenderer() {\n    return this._view?.renderer;\n  }\n\n  /**\n   * 获取 canvas dom\n   * @returns HTMLCanvasElement | undefined\n   */\n  getCanvas(): HTMLCanvasElement | undefined {\n    return this._view?.renderer.canvas();\n  }\n\n  /**\n   * 获取 渲染引擎\n   */\n  getStage(): Stage | undefined {\n    return this._view?.renderer.stage();\n  }\n\n  initView() {\n    if (this.isReleased) {\n      return;\n    }\n    this.isInited = true;\n    if (this._view) {\n      return;\n    }\n    const logger = new Logger(this._option.logLevel ?? LoggerLevel.Error);\n    if (this._option?.onError) {\n      logger.addErrorHandler((...args) => {\n        this._option?.onError?.(...args);\n      });\n    }\n    this._view = new View({\n      width: this._width,\n      height: this._height,\n      container: this._container.dom ?? null,\n      renderCanvas: this._container.canvas ?? null,\n      hooks: (this._option as any).performanceHook, // vgrammar 事件改造后，性能回调函数放在了hooks中实现\n      ...this._option,\n      mode: toRenderMode(this._option.mode),\n      autoFit: false,\n      eventConfig: {\n        gesture: isMobileLikeMode(this._option.mode),\n        disable: this._option.interactive === false\n      },\n      doLayout: () => {\n        this._compileChart?.onLayout(this._view);\n      },\n      logger: logger,\n      logLevel: logger.level()\n    });\n    this._setCanvasStyle();\n\n    // emit afterRender event\n    this.getStage().hooks.afterRender.tap('chart-event', () => {\n      this._compileChart?.getEvent()?.emit(ChartEvent.afterRender, { chart: this._compileChart });\n    });\n\n    const interactive = this._option.interactive;\n    if (interactive !== false) {\n      // 将 view 实例化之前监听的事件挂载到 view 上\n      this._viewListeners.forEach(listener => {\n        this._view?.addEventListener(listener.type, listener.callback);\n      });\n    }\n  }\n\n  private _setCanvasStyle() {\n    if (!this._view) {\n      return;\n    }\n    if (this._container.dom && !isString(this._container.dom)) {\n      this._container.dom.style.display = 'block';\n      this._container.dom.style.position = 'relative';\n      const canvas = this.getCanvas();\n      if (canvas) {\n        canvas.style.display = 'block';\n      }\n    }\n  }\n\n  compile(ctx: { chart: IChart; vChart: VChart }, option: any) {\n    const { chart } = ctx;\n    this._compileChart = chart;\n    this.initView();\n    if (!this._view) {\n      return;\n    }\n\n    chart.compile();\n    chart.afterCompile();\n    this.updateDepend();\n  }\n\n  clear(ctx: { chart: IChart; vChart: VChart }, removeGraphicItems: boolean = false) {\n    const { chart } = ctx;\n    chart.clear();\n    this.releaseGrammar(removeGraphicItems);\n  }\n\n  async renderAsync(morphConfig?: IMorphConfig): Promise<any> {\n    if (this.isReleased) {\n      return;\n    }\n    this.initView();\n    if (!this._view) {\n      return Promise.reject('srView init fail');\n    }\n    await this._view?.runNextTick(morphConfig);\n    return this;\n  }\n\n  renderSync(morphConfig?: IMorphConfig): void {\n    this.initView();\n    if (!this._view) {\n      return;\n    }\n    this._view?.runSync(morphConfig);\n  }\n\n  updateViewBox(viewBox: IBoundsLike, reRender: boolean = true) {\n    if (!this._view) {\n      return;\n    }\n\n    this._view.renderer.setViewBox(viewBox, reRender);\n  }\n\n  resize(width: number, height: number, reRender: boolean = true) {\n    if (!this._view) {\n      return Promise.reject();\n    }\n    this._width = width;\n    this._height = height;\n\n    this._view.resize(width, height);\n    return reRender ? this.renderAsync({ morph: false }) : this;\n  }\n\n  setBackground(color: IColor) {\n    this._view?.background(color);\n  }\n\n  setSize(width: number, height: number) {\n    this._width = width;\n    this._height = height;\n    if (!this._view) {\n      return;\n    }\n\n    this._view.width(width);\n    this._view.height(height);\n  }\n\n  setViewBox(viewBox: IBoundsLike, reRender: boolean = true) {\n    if (!this._view) {\n      return;\n    }\n\n    this._view.renderer.setViewBox(viewBox, reRender);\n  }\n\n  addEventListener(\n    source: EventSourceType,\n    type: string,\n    callback: (params: CompilerListenerParameters) => void\n  ): void {\n    // TODO: 需要明确一下 interactive 的作用范围，同时考虑是否存在非交互行为的事件以及是否需要生效\n    if (this._option.interactive === false) {\n      return;\n    }\n    if (source === Event_Source_Type.chart) {\n      const wrappedCallback = function (event: any, element: IElement | null) {\n        const context = element?.mark?.getContext() ?? {};\n        const modelId = isValid(context.modelId) ? context.modelId : null;\n        const markId = isValid(context.markId) ? context.markId : null;\n        const modelUserId = isValid(context.modelUserId) ? context.modelUserId : null;\n        const markUserId = isValid(context.markUserId) ? context.markUserId : null;\n\n        const params: CompilerListenerParameters = {\n          event,\n          type,\n          source,\n          item: element,\n          datum: element?.getDatum?.() || null,\n          markId,\n          modelId,\n          markUserId,\n          modelUserId\n        };\n        callback.call(null, params);\n      }.bind(this);\n      this._viewListeners.set(callback, { type, callback: wrappedCallback });\n      // 如果 view 已经初始化则立刻挂载监听\n      // FIXME: 目前 vgrammar 类型声明没有对齐，事件相关类型声明并没有使用 SceneItem\n      this._view?.addEventListener(type, wrappedCallback as any);\n    } else if (source === Event_Source_Type.window) {\n      const wrappedCallback = function wrappedCallback(event: any) {\n        // TODO: vgrammar 暂未提供基于事件直接筛选相应 mark 的能力，这里无法获取到相应的 item\n        const params: CompilerListenerParameters = {\n          event,\n          type,\n          source,\n          item: null,\n          datum: null,\n          markId: null,\n          modelId: null,\n          markUserId: null,\n          modelUserId: null\n        };\n        callback.call(null, params);\n      }.bind(this);\n      this._windowListeners.set(callback, { type, callback: wrappedCallback });\n      const windowObject = this._getGlobalThis();\n      windowObject?.addEventListener(type, wrappedCallback);\n    } else if (source === Event_Source_Type.canvas) {\n      const wrappedCallback = function wrappedCallback(event: any) {\n        // TODO: vgrammar 暂未提供基于事件直接筛选相应 mark 的能力，这里无法获取到相应的 item\n        const params: CompilerListenerParameters = {\n          event,\n          type,\n          source,\n          item: null,\n          datum: null,\n          markId: null,\n          modelId: null,\n          markUserId: null,\n          modelUserId: null\n        };\n        callback.call(null, params);\n      }.bind(this);\n      this._canvasListeners.set(callback, { type, callback: wrappedCallback });\n      const canvasObject = this.getStage()?.window;\n      canvasObject?.addEventListener(type, wrappedCallback);\n    }\n  }\n\n  removeEventListener(\n    source: EventSourceType,\n    type: string,\n    callback: (params: CompilerListenerParameters) => void\n  ): void {\n    if (this._option.interactive === false) {\n      return;\n    }\n    if (source === Event_Source_Type.chart) {\n      const wrappedCallback = this._viewListeners.get(callback)?.callback;\n      wrappedCallback && this._view?.removeEventListener(type, wrappedCallback);\n      this._viewListeners.delete(callback);\n    } else if (source === Event_Source_Type.window) {\n      const windowObject = this._getGlobalThis();\n      const wrappedCallback = this._windowListeners.get(callback)?.callback;\n      wrappedCallback && windowObject?.removeEventListener(type, wrappedCallback);\n      this._windowListeners.delete(callback);\n    } else if (source === Event_Source_Type.canvas) {\n      const canvasObject = this._getGlobalThis();\n      const wrappedCallback = this._canvasListeners.get(callback)?.callback;\n      wrappedCallback && canvasObject?.removeEventListener(type, wrappedCallback);\n      this._canvasListeners.delete(callback);\n    }\n  }\n\n  protected releaseEvent(): void {\n    // 相应的事件remove在model中完成\n    this._viewListeners.clear();\n    this._windowListeners.clear();\n    this._canvasListeners.clear();\n  }\n\n  release(): void {\n    this.releaseEvent();\n    this._option = this._container = null as any;\n    // vgrammar release\n    this._releaseModel();\n    this._view?.release();\n    this._view = null;\n    this.isInited = false;\n    this.isReleased = true;\n  }\n\n  /**\n   * 释放VGrammar\n   * @param removeGraphicItems 是否删除场景元素，在同步渲染，并且无动画时，必须设置为true，否则有绘图残留\n   */\n  releaseGrammar(removeGraphicItems: boolean = false) {\n    this._releaseModel();\n    if (removeGraphicItems) {\n      this._view?.removeAllGraphicItems();\n    }\n    this._view?.removeAllGrammars();\n  }\n\n  protected _releaseModel() {\n    // 释放model\n    Object.keys(this._model).forEach(type => {\n      Object.values(this._model[type] as IProductMap<IGrammarItem>).forEach(grammarItemMap => {\n        Object.values(grammarItemMap).forEach((item: IGrammarItem) => {\n          item.removeProduct(true); // 保留 vgrammar 语法元素，下面一起清空\n        });\n      });\n      this._model[type] = {};\n    });\n  }\n\n  /** 添加语法元素 */\n  addGrammarItem(grammarItem: IGrammarItem) {\n    const product = grammarItem.getProduct();\n    if (isNil(product)) {\n      return;\n    }\n    const id = product.id();\n    const type = grammarItem.grammarType;\n    if (isNil(this._model[type][id])) {\n      this._model[type][id] = {};\n    }\n    this._model[type][id][grammarItem.id] = grammarItem;\n  }\n\n  /** 删除语法元素 */\n  removeGrammarItem(grammarItem: IGrammarItem, reserveVGrammarModel?: boolean) {\n    const product = grammarItem.getProduct();\n    if (isNil(product)) {\n      return;\n    }\n    const id = product.id();\n    const type = grammarItem.grammarType;\n    const map = this._model[type][id];\n    if (isValid(map)) {\n      delete map[grammarItem.id];\n      if (Object.keys(map).length === 0) {\n        delete this._model[type][id];\n      }\n    }\n    if (!reserveVGrammarModel) {\n      this._view?.removeGrammar(product);\n    }\n  }\n\n  /** 更新语法元素间的依赖关系，返回是否全部成功更新 */\n  updateDepend(items?: IGrammarItem[]): boolean {\n    if (isValid(items) && items.length > 0) {\n      // 局部更新依赖\n      return items.every(item => item.updateDepend());\n    }\n    // 全局更新依赖\n    Object.values(this._model).forEach(productMap => {\n      Object.values(productMap).forEach(grammarItemMap => {\n        const grammarItems = Object.values(grammarItemMap) as IGrammarItem[];\n        // 获取编译产物\n        const product = grammarItems[0].getProduct();\n\n        // 获取编译产物的依赖项\n        const dependList = grammarItems\n          .reduce((depend, item) => {\n            if (item.getDepend().length > 0) {\n              return depend.concat(item.getDepend());\n            }\n            return depend;\n          }, [] as IGrammarItem[])\n          .filter(grammarItem => !!grammarItem)\n          .map(grammarItem => grammarItem.getProduct());\n\n        // 更新依赖\n        product.depend(dependList);\n      });\n    });\n    return true;\n  }\n\n  private _getGlobalThis() {\n    return isTrueBrowser(this._option.mode) ? globalThis : this.getStage()?.window;\n  }\n}\n"]}