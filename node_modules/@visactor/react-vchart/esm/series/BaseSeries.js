import React from "react";

import { isNil, isEqual, pickWithout } from "@visactor/vutils";

import RootChartContext from "../context/chart";

import { REACT_TO_VCHART_EVENTS, findEventProps, COMMON_EVENTK_KEYS, VCHART_TO_REACT_EVENTS } from "../eventsUtils";

import { uid } from "../util";

export const createSeries = (componentName, markNames, type) => {
    const notSpecKeys = COMMON_EVENTK_KEYS.concat([ "id", "updateId" ]), Comp = props => {
        const context = React.useContext(RootChartContext), id = React.useRef(isNil(props.id) ? uid(null != type ? type : "series") : props.id), seriesSpec = React.useRef(), bindedEvents = React.useRef({}), updateId = React.useRef(props.updateId), handleEvent = e => {
            const markIds = markNames.map((markName => `${id.current}-${markName}`));
            (null == e ? void 0 : e.mark) && markIds.includes(e.mark.getUserId()) && props[VCHART_TO_REACT_EVENTS[e.event.type]](e);
        }, addMarkEvent = events => {
            events && context.chart && (bindedEvents && Object.keys(bindedEvents).forEach((eventKey => {
                events[eventKey] || context.chart.off(REACT_TO_VCHART_EVENTS[eventKey], handleEvent), 
                bindedEvents.current[eventKey] = !1;
            })), Object.keys(events).forEach((eventKey => {
                (null == bindedEvents ? void 0 : bindedEvents[eventKey]) || (context.chart.on(REACT_TO_VCHART_EVENTS[eventKey], handleEvent), 
                bindedEvents || (bindedEvents.current = {}), bindedEvents.current[eventKey] = !0);
            })));
        }, addMarkId = spec => {
            markNames.forEach((markName => {
                const defaultMarkId = `${id.current}-${markName}`;
                isNil(spec[markName]) ? spec[markName] = {
                    id: defaultMarkId
                } : isNil(spec[markName].id) && (spec[markName].id = defaultMarkId);
            }));
        }, insertToContext = props => {
            if (context.specFromChildren) {
                context.specFromChildren.series || (context.specFromChildren.series = []);
                const spec = isNil(type) ? Object.assign(Object.assign({}, props), {
                    id: id.current
                }) : Object.assign(Object.assign({}, props), {
                    id: id.current,
                    type: type
                });
                addMarkId(spec), context.specFromChildren.series.push(spec), context.isChildrenUpdated = !0;
            }
        };
        if (addMarkEvent(findEventProps(props)), props.updateId !== updateId.current) updateId.current = props.updateId; else {
            const newSeriesSpec = pickWithout(props, notSpecKeys);
            addMarkId(newSeriesSpec), isEqual(newSeriesSpec, seriesSpec.current) || (seriesSpec.current = newSeriesSpec, 
            (props => {
                if (!context.specFromChildren) return;
                if (!context.specFromChildren.series) return void insertToContext(props);
                const series = context.specFromChildren.series, index = series.findIndex((entry => entry.id === id.current));
                index >= 0 ? (series[index] = isNil(type) ? Object.assign(Object.assign({}, props), {
                    id: id.current
                }) : Object.assign(Object.assign({}, props), {
                    id: id.current,
                    type: type
                }), addMarkId(series[index])) : insertToContext(props), context.isChildrenUpdated = !0;
            })(newSeriesSpec));
        }
        return React.useEffect((() => () => {
            (() => {
                var _a;
                if (!context.specFromChildren) return;
                const series = null !== (_a = context.specFromChildren.series) && void 0 !== _a ? _a : [], index = series.findIndex((entry => entry.id === id.current));
                if (index >= 0) {
                    const newSeries = series.slice(0, index - 1).concat(series.slice(index + 1));
                    context.specFromChildren.series = newSeries, context.isChildrenUpdated = !0;
                }
            })(), addMarkEvent({});
        }), []), null;
    };
    return Comp.displayName = componentName, Comp;
};
//# sourceMappingURL=BaseSeries.js.map