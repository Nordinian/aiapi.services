{"version":3,"sources":["../src/picker/contributions/canvas-picker/rect3d-picker.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AACA,6CAA8C;AAC9C,yDAAsH;AAWtH,+CAA2C;AAE3C,MAAM,OAAO,GAAG,IAAI,mBAAU,EAAE,CAAC;AAG1B,IAAM,yBAAyB,GAA/B,MAAM,yBAA0B,SAAQ,wBAAmB;IAIhE,YAAkD,cAA8B;QAC9E,KAAK,EAAE,CAAC;QADwC,mBAAc,GAAd,cAAc,CAAgB;QAHhF,SAAI,GAAW,QAAQ,CAAC;QACxB,eAAU,GAAW,iCAAkB,CAAC;IAIxC,CAAC;IAED,QAAQ,CAAC,IAAa,EAAE,KAAa,EAAE,MAAoB;QAQzD,MAAM,EAAE,WAAW,EAAE,GAAG,MAAM,aAAN,MAAM,cAAN,MAAM,GAAI,EAAE,CAAC;QACrC,IAAI,CAAC,WAAW,EAAE;YAChB,OAAO,KAAK,CAAC;SACd;QAGD,MAAM,aAAa,GAAG,IAAA,uBAAQ,EAAC,IAAI,CAAC,CAAC,IAAI,CAAC;QAE1C,WAAW,CAAC,mBAAmB,EAAE,CAAC;QAClC,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,aAAa,EAAE,WAAW,CAAC,CAAC;QAC9D,MAAM,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,eAAe,EAAE,GAAG,IAAI,CAAC;QAE1C,IAAI,SAAS,GAAG,KAAK,CAAC;QACtB,IAAI,WAAW,CAAC,MAAM,EAAE;YACtB,SAAS,GAAG,KAAK,CAAC,KAAK,EAAE,CAAC;YAC1B,MAAM,YAAY,GAAG,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC;YACnD,SAAS,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,CAAC;YACnF,SAAS,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,GAAG,KAAK,CAAC,CAAC,GAAG,YAAY,CAAC,CAAC,CAAC;SACpF;QAED,IAAI,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,CAAC;QAC1B,IAAI,MAAM,GAAG,KAAK,CAAC;QACnB,IAAI,CAAC,cAAc,CAAC,SAAS,CAC3B,IAAI,EACJ,WAAW,EACX,CAAC,EACD,CAAC,EACD,MAAa,EACb,IAAI,EACJ,CACE,OAAmB,EACnB,cAA2D,EAC3D,cAA+B,EAC/B,EAAE;YAEF,IAAI,MAAM,EAAE;gBACV,OAAO,IAAI,CAAC;aACb;YACD,MAAM,GAAG,OAAO,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC;YACzD,OAAO,MAAM,CAAC;QAChB,CAAC,CAeF,CAAC;QACF,IAAI,CAAC,cAAc,CAAC,CAAC,GAAG,CAAC,CAAC;QAE1B,IAAI,WAAW,CAAC,WAAW,KAAK,eAAe,EAAE;YAC/C,2BAAY,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;SAC5C;QACD,WAAW,CAAC,WAAW,GAAG,eAAe,CAAC;QAC1C,WAAW,CAAC,sBAAsB,EAAE,CAAC;QACrC,OAAO,MAAM,CAAC;IAChB,CAAC;CACF,CAAA;AAjFY,yBAAyB;IADrC,IAAA,yBAAU,GAAE;IAKE,WAAA,IAAA,qBAAM,EAAC,2BAAY,CAAC,CAAA;;GAJtB,yBAAyB,CAiFrC;AAjFY,8DAAyB","file":"rect3d-picker.js","sourcesContent":["import type { IPoint } from '@visactor/vutils';\nimport { AABBBounds } from '@visactor/vutils';\nimport { inject, injectable, getTheme, mat4Allocate, Rect3DRender, RECT3D_NUMBER_TYPE } from '@visactor/vrender-core';\nimport type {\n  IGraphicAttribute,\n  IContext2d,\n  IMarkAttribute,\n  IRect3d,\n  IThemeAttribute,\n  IGraphicPicker,\n  IGraphicRender,\n  IPickParams\n} from '@visactor/vrender-core';\nimport { BasePicker } from './base-picker';\n\nconst _bounds = new AABBBounds();\n\n@injectable()\nexport class DefaultCanvasRect3dPicker extends BasePicker<IRect3d> implements IGraphicPicker {\n  type: string = 'rect3d';\n  numberType: number = RECT3D_NUMBER_TYPE;\n\n  constructor(@inject(Rect3DRender) public readonly canvasRenderer: IGraphicRender) {\n    super();\n  }\n\n  contains(rect: IRect3d, point: IPoint, params?: IPickParams): boolean {\n    // if (!rect.AABBBounds.containsPoint(point)) {\n    //   return false;\n    // }\n    // if (rect.attribute.pickMode === 'imprecise') {\n    //   return true;\n    // }\n\n    const { pickContext } = params ?? {};\n    if (!pickContext) {\n      return false;\n    }\n\n    // const { rectAttribute } = graphicService.themeService.getCurrentTheme();\n    const rectAttribute = getTheme(rect).rect;\n\n    pickContext.highPerformanceSave();\n    const data = this.transform(rect, rectAttribute, pickContext);\n    const { x, y, z, lastModelMatrix } = data;\n\n    let pickPoint = point;\n    if (pickContext.camera) {\n      pickPoint = point.clone();\n      const globalMatrix = rect.parent.globalTransMatrix;\n      pickPoint.x = globalMatrix.a * point.x + globalMatrix.c * point.y + globalMatrix.e;\n      pickPoint.y = globalMatrix.b * point.x + globalMatrix.d * point.y + globalMatrix.f;\n    }\n\n    this.canvasRenderer.z = z;\n    let picked = false;\n    this.canvasRenderer.drawShape(\n      rect,\n      pickContext,\n      x,\n      y,\n      params as any,\n      null,\n      (\n        context: IContext2d,\n        arc3dAttribute: Partial<IMarkAttribute & IGraphicAttribute>,\n        themeAttribute: IThemeAttribute\n      ) => {\n        // 选中后面就不需要再走逻辑了\n        if (picked) {\n          return true;\n        }\n        picked = context.isPointInPath(pickPoint.x, pickPoint.y);\n        return picked;\n      }\n      // (\n      //   context: IContext2d,\n      //   arc3dAttribute: Partial<IMarkAttribute & IGraphicAttribute>,\n      //   themeAttribute: IThemeAttribute\n      // ) => {\n      //   // 选中后面就不需要再走逻辑了\n      //   if (picked) {\n      //     return true;\n      //   }\n      //   const lineWidth = arc3dAttribute.lineWidth || themeAttribute.lineWidth;\n      //   pickContext.lineWidth = getScaledStroke(pickContext, lineWidth, pickContext.dpr);\n      //   picked = context.isPointInStroke(point.x, point.y);\n      //   return picked;\n      // }\n    );\n    this.canvasRenderer.z = 0;\n\n    if (pickContext.modelMatrix !== lastModelMatrix) {\n      mat4Allocate.free(pickContext.modelMatrix);\n    }\n    pickContext.modelMatrix = lastModelMatrix;\n    pickContext.highPerformanceRestore();\n    return picked; // 无圆角形状判断通过\n  }\n}\n"]}