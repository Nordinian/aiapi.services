{"version":3,"sources":["../src/series/waterfall/waterfall.ts"],"names":[],"mappings":"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","file":"waterfall.js","sourcesContent":["/* eslint-disable no-duplicate-imports */\nimport type { IRuleMark } from '../../mark/rule';\nimport { isNil, precisionSub } from '@visactor/vutils';\nimport {\n  AttributeLevel,\n  PREFIX,\n  STACK_FIELD_END,\n  STACK_FIELD_START,\n  WaterfallDefaultSeriesField\n} from '../../constant/index';\nimport { waterfall, waterfallFillTotal } from '../../data/transforms/waterfall';\nimport { BarSeries } from '../bar/bar';\nimport { valueInScaleRange } from '../../util/scale';\nimport { registerWaterfallAnimation, type WaterfallAppearPreset } from './animation';\nimport { animationConfig, userAnimationConfig } from '../../animation/utils';\nimport type { IWaterfallSeriesSpec, IWaterfallSeriesTheme } from './interface';\nimport type { SeriesMarkMap } from '../interface';\nimport { SeriesMarkNameEnum, SeriesTypeEnum } from '../interface/type';\nimport { registerFadeInOutAnimation } from '../../animation/config';\nimport type { ITransformOptions, DataView } from '@visactor/vdataset';\nimport { registerDataSetInstanceTransform } from '../../data/register';\nimport { SeriesData } from '../base/series-data';\nimport { dataViewFromDataView } from '../../data/initialize';\nimport type { IStateAnimateSpec } from '../../animation/spec';\nimport type { ITextMark } from '../../mark/text';\nimport type { IModelEvaluateOption } from '../../model/interface';\nimport type { Datum, Maybe } from '../../typings';\nimport { Direction } from '../../typings/space';\nimport type { IBarAnimationParams } from '../bar/animation';\nimport { registerRuleMark } from '../../mark/rule';\nimport { waterfallSeriesMark } from './constant';\nimport { Group } from '../base/group';\nimport type { ILabelMark } from '../../mark/label';\nimport { Factory } from '../../core/factory';\nimport { registerRectMark } from '../../mark/rect';\nimport { getGroupAnimationParams } from '../util/utils';\nimport { WaterfallSeriesSpecTransformer } from './waterfall-transformer';\n\nexport const DefaultBandWidth = 6; // 默认的bandWidth，避免连续轴没有bandWidth\n\nexport class WaterfallSeries<T extends IWaterfallSeriesSpec = IWaterfallSeriesSpec> extends BarSeries<any> {\n  static readonly type: string = SeriesTypeEnum.waterfall;\n  type = SeriesTypeEnum.waterfall;\n\n  static readonly mark: SeriesMarkMap = waterfallSeriesMark;\n  static readonly transformerConstructor = WaterfallSeriesSpecTransformer as any;\n  readonly transformerConstructor = WaterfallSeriesSpecTransformer as any;\n\n  protected _stack: boolean = false;\n\n  protected _totalData?: SeriesData;\n  getTotalData() {\n    return this._totalData?.getLatestData();\n  }\n\n  protected declare _spec: T;\n\n  protected _leaderLineMark: IRuleMark = null;\n  protected _stackLabelMark: ITextMark = null;\n  protected _labelMark: ITextMark = null;\n\n  protected initGroups() {\n    const groupFields = this.getGroupFields();\n    if (groupFields && groupFields.length) {\n      this._groups = new Group(groupFields);\n      this._data && this._groups.initData(this._data.getDataView(), this._dataSet);\n    }\n  }\n\n  setAttrFromSpec() {\n    super.setAttrFromSpec();\n    // waterfall data stack data\n    this.setValueFieldToStack();\n    // 不支持多维度;\n    this._fieldX = [this._fieldX[0]];\n    this._fieldY = [this._fieldY[0]];\n    if (isNil(this._seriesField)) {\n      this._seriesField = WaterfallDefaultSeriesField;\n    }\n  }\n\n  getSeriesKeys(): string[] {\n    if (this._seriesField === WaterfallDefaultSeriesField) {\n      return [\n        this._theme.seriesFieldName.increase,\n        this._theme.seriesFieldName.decrease,\n        this._theme.seriesFieldName.total\n      ];\n    }\n    return super.getSeriesKeys();\n  }\n\n  protected initData(): void {\n    super.initData();\n    registerDataSetInstanceTransform(this._dataSet, 'waterfallFillTotal', waterfallFillTotal);\n    registerDataSetInstanceTransform(this._dataSet, 'waterfall', waterfall);\n    // 如果要在最后添加总计\n    if (isNil(this._spec.total) || this._spec.total.type === 'end') {\n      this._rawData?.transform(\n        {\n          type: 'waterfallFillTotal',\n          options: {\n            indexField: this.getGroupFields()[0],\n            valueField: this.getStackValueField(),\n            seriesField: this.getSeriesField(),\n            seriesFieldName: this._theme.seriesFieldName,\n            total: this._spec.total\n          }\n        },\n        false\n      );\n    }\n    // 总计数据\n    const totalData = dataViewFromDataView(this.getViewData(), this._dataSet, {\n      name: `${PREFIX}_series_${this.id}_totalData`\n    });\n    this.getViewData().target.removeListener('change', totalData.reRunAllTransform);\n    this._totalData = new SeriesData(this._option, totalData);\n    totalData.transform(\n      {\n        type: 'waterfall',\n        options: {\n          indexField: this.getGroupFields()[0],\n          valueField: this.getStackValueField(),\n          seriesField: this.getSeriesField(),\n          seriesFieldName: this._theme.seriesFieldName,\n          startAs: STACK_FIELD_START,\n          endAs: STACK_FIELD_END,\n          total: this._spec.total,\n          groupData: () => this.getGroups().groupData\n        }\n      },\n      false\n    );\n  }\n\n  initAnimation() {\n    // 这个数据在这个时候拿不到，因为组件还没创建结束，统计和筛选也还没添加。\n    // 而且这个值理论上是动态的，建议 监听 viewDataStatisticsUpdate 消息动态更新\n    const waterfallAnimationParams: IBarAnimationParams = {\n      yField: this.direction === 'horizontal' ? this._fieldY[0] : this.getStackValueField(),\n      xField: this.direction === 'horizontal' ? this.getStackValueField() : this._fieldX[0],\n      direction: this.direction,\n      growFrom: () =>\n        this.direction === 'horizontal'\n          ? this._xAxisHelper?.getScale(0).scale(0)\n          : this._yAxisHelper?.getScale(0).scale(0)\n    };\n    const appearPreset = (this._spec?.animationAppear as IStateAnimateSpec<WaterfallAppearPreset>)?.preset;\n    const animationParams = getGroupAnimationParams(this);\n\n    this._barMark.setAnimationConfig(\n      animationConfig(\n        Factory.getAnimationInKey('waterfall')?.(waterfallAnimationParams, appearPreset),\n        userAnimationConfig(SeriesMarkNameEnum.bar, this._spec, this._markAttributeContext),\n        animationParams\n      )\n    );\n\n    if (this._leaderLineMark) {\n      this._leaderLineMark.setAnimationConfig(\n        animationConfig(\n          Factory.getAnimationInKey('fadeInOut')?.(),\n          userAnimationConfig(SeriesMarkNameEnum.leaderLine, this._spec, this._markAttributeContext)\n        )\n      );\n    }\n  }\n\n  viewDataUpdate(d: DataView): void {\n    this._totalData.getDataView().reRunAllTransform();\n    this._totalData.updateData();\n    super.viewDataUpdate(d);\n  }\n  /**\n   * data\n   */\n  // waterfall 不支持任何的 data filter\n  addViewDataFilter(_option: ITransformOptions) {\n    // do nothing\n  }\n  reFilterViewData() {\n    // do nothing\n  }\n\n  onEvaluateEnd(ctx: IModelEvaluateOption): void {\n    super.onEvaluateEnd(ctx);\n    this._totalData.updateData();\n  }\n\n  initMark(): void {\n    super.initMark();\n    const leaderLine = this._createMark(WaterfallSeries.mark.leaderLine, {\n      key: 'index',\n      customShape: this._spec.leaderLine?.customShape\n    }) as IRuleMark;\n    if (leaderLine) {\n      this._leaderLineMark = leaderLine;\n      leaderLine.setDataView(this._totalData.getDataView(), this._totalData.getProductId());\n    }\n  }\n\n  initLabelMarkStyle(labelMark: ILabelMark): void {\n    if (!labelMark) {\n      return;\n    }\n\n    if (!this._labelMark && this._spec.label?.visible) {\n      super.initLabelMarkStyle(labelMark);\n      this._labelMark = labelMark;\n      return;\n    }\n\n    this._stackLabelMark = labelMark;\n    // 瀑布图标签 encode 在自定义布局中计算\n    labelMark.skipEncode = true;\n    labelMark.setRule('stackLabel');\n    labelMark.setDataView(this._totalData.getDataView(), this._totalData.getProductId());\n\n    this.setMarkStyle(labelMark, {\n      text: (datum: Datum) => {\n        return this._spec.stackLabel?.valueType === 'absolute' ? datum.end : precisionSub(datum.end, datum.start);\n      }\n    });\n  }\n\n  totalPositionX(datum: Datum, field: string, pos: number = 0.5) {\n    const { dataToPosition, getBandwidth } = this._xAxisHelper;\n    if (this._direction === Direction.vertical) {\n      return (\n        dataToPosition([datum[field]], {\n          bandPosition: this._bandPosition\n        }) +\n        getBandwidth(0) * 0.5 -\n        (this._barMark.getAttribute('width', datum) as number) * (0.5 - pos)\n      );\n    }\n    return valueInScaleRange(\n      dataToPosition([datum[field]], {\n        bandPosition: this._bandPosition\n      })\n    );\n  }\n\n  totalPositionY(datum: Datum, field: string, pos: number = 0.5) {\n    const { dataToPosition, getBandwidth } = this._yAxisHelper;\n    if (this._direction === Direction.vertical) {\n      return valueInScaleRange(\n        dataToPosition([datum[field]], {\n          bandPosition: this._bandPosition\n        })\n      );\n    }\n    return (\n      dataToPosition([datum[field]], {\n        bandPosition: this._bandPosition\n      }) +\n      getBandwidth(0) * 0.5 -\n      (this._barMark.getAttribute('height', datum) as number) * (0.5 - pos)\n    );\n  }\n\n  initMarkStyle(): void {\n    super.initMarkStyle();\n    if (this._leaderLineMark) {\n      if (this._direction === Direction.vertical) {\n        this.setMarkStyle(\n          this._leaderLineMark,\n          {\n            visible: (datum: Datum) => !isNil(datum.lastIndex),\n            x: (datum: Datum) => {\n              if (!datum.lastIndex) {\n                return 0;\n              }\n              return this.totalPositionX(datum, 'lastIndex', 1);\n            },\n            x1: (datum: Datum) => this.totalPositionX(datum, 'index', 0),\n            y: (datum: Datum) => this.totalPositionY(datum, 'lastEnd', 0),\n            y1: (datum: Datum) => this.totalPositionY(datum, datum.isTotal ? 'end' : 'start', 0)\n          },\n          'normal',\n          AttributeLevel.Series\n        );\n      } else {\n        this.setMarkStyle(\n          this._leaderLineMark,\n          {\n            visible: (datum: Datum) => !isNil(datum.lastIndex),\n            x: (datum: Datum) => this.totalPositionX(datum, 'lastEnd', 0),\n            x1: (datum: Datum) => this.totalPositionX(datum, datum.isTotal ? 'end' : 'start', 0),\n            y: (datum: Datum) => {\n              if (!datum.lastIndex) {\n                return 0;\n              }\n              return this.totalPositionY(datum, 'lastIndex', 1);\n            },\n            y1: (datum: Datum) => this.totalPositionY(datum, 'index', 0)\n          },\n          'normal',\n          AttributeLevel.Series\n        );\n      }\n    }\n  }\n}\n\nexport const registerWaterfallSeries = () => {\n  registerRuleMark();\n  registerRectMark();\n  registerWaterfallAnimation();\n  registerFadeInOutAnimation();\n  Factory.registerSeries(WaterfallSeries.type, WaterfallSeries);\n};\n"]}