{"version":3,"sources":["../src/charts/BaseChart.tsx"],"names":[],"mappings":"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","file":"BaseChart.js","sourcesContent":["import type { IVChart, IData, IInitOption, ISpec, IVChartConstructor } from '@visactor/vchart';\nimport React, { useState, useEffect, useRef, useImperativeHandle } from 'react';\nimport withContainer, { ContainerProps } from '../containers/withContainer';\nimport RootChartContext, { ChartContextType } from '../context/chart';\nimport type { IView } from '@visactor/vgrammar-core';\nimport { isEqual, pickWithout } from '@visactor/vutils';\nimport ViewContext from '../context/view';\nimport { toArray } from '../util';\nimport { REACT_PRIVATE_PROPS } from '../constants';\nimport { IMarkElement } from '../components';\nimport {\n  bindEventsToChart,\n  EventsProps,\n  CHART_EVENTS_KEYS,\n  CHART_EVENTS,\n  LegendEventProps,\n  ScrollBarEventProps,\n  BrushEventProps,\n  DataZoomEventProps,\n  PlayerEventProps,\n  DimensionEventProps,\n  HierarchyEventProps,\n  ChartLifeCycleEventProps\n} from '../eventsUtils';\n\nexport type ChartOptions = Omit<IInitOption, 'dom'>;\n\nexport interface BaseChartProps\n  extends EventsProps,\n    LegendEventProps,\n    ScrollBarEventProps,\n    BrushEventProps,\n    DataZoomEventProps,\n    PlayerEventProps,\n    DimensionEventProps,\n    HierarchyEventProps,\n    ChartLifeCycleEventProps {\n  vchartConstrouctor?: IVChartConstructor;\n  type?: string;\n  /** 上层container */\n  container?: HTMLDivElement;\n  /**\n   * used only by <VChart />\n   */\n  spec?: ISpec;\n  /** 数据 */\n  data?: IData;\n  /** 画布宽度 */\n  width?: number;\n  /** 画布高度 */\n  height?: number;\n  /** 图表配置 */\n  options?: ChartOptions;\n  /** skip function diff when component update */\n  skipFunctionDiff?: boolean;\n  /** 图表渲染完成事件 */\n  onReady?: (instance: IVChart, isInitial: boolean) => void;\n  /** throw error when chart run into an error */\n  onError?: (err: Error) => void;\n  /**\n   * use sync render\n   *\n   * @since 1.8.3\n   **/\n  useSyncRender?: boolean;\n}\n\ntype Props = React.PropsWithChildren<BaseChartProps>;\n\nconst notSpecKeys = [\n  ...REACT_PRIVATE_PROPS,\n  ...CHART_EVENTS_KEYS,\n  'skipFunctionDiff',\n  'onError',\n  'onReady',\n  'spec',\n  'container',\n  'options'\n];\n\nconst BaseChart: React.FC<Props> = React.forwardRef((props, ref) => {\n  const [updateId, setUpdateId] = useState<number>(0);\n  const chartContext = useRef<ChartContextType>({\n    specFromChildren: {}\n  });\n  useImperativeHandle(ref, () => chartContext.current?.chart);\n  const hasSpec = !!props.spec;\n  const [view, setView] = useState<IView>(null);\n  const isUnmount = useRef<boolean>(false);\n  const prevSpec = useRef(pickWithout(props, notSpecKeys));\n  const eventsBinded = React.useRef<BaseChartProps>(null);\n  const skipFunctionDiff = !!props.skipFunctionDiff;\n  const useSyncRender = !!props.useSyncRender;\n\n  const parseSpec = (props: Props) => {\n    if (hasSpec && props.spec) {\n      return props.spec;\n    }\n\n    return {\n      ...prevSpec.current,\n      ...chartContext.current?.specFromChildren\n    };\n  };\n\n  const createChart = (props: Props) => {\n    const cs = new props.vchartConstrouctor(parseSpec(props), {\n      ...props.options,\n      onError: props.onError,\n      autoFit: true,\n      dom: props.container\n    });\n    chartContext.current = { ...chartContext.current, chart: cs };\n  };\n\n  const handleChartRender = () => {\n    // rebind events after render\n    if (!isUnmount.current) {\n      if (!chartContext.current || !chartContext.current.chart) {\n        return;\n      }\n\n      bindEventsToChart(chartContext.current.chart, props, eventsBinded.current, CHART_EVENTS);\n\n      const newView = chartContext.current.chart.getCompiler().getVGrammarView();\n\n      setUpdateId(updateId + 1);\n      if (props.onReady) {\n        props.onReady(chartContext.current.chart, updateId === 0);\n      }\n      setView(newView);\n    }\n  };\n\n  const renderChart = () => {\n    if (chartContext.current.chart) {\n      if (useSyncRender) {\n        chartContext.current.chart.renderSync();\n        handleChartRender();\n      } else {\n        // eslint-disable-next-line promise/catch-or-return\n        chartContext.current.chart.renderAsync().then(handleChartRender);\n      }\n    }\n  };\n\n  useEffect(() => {\n    if (!chartContext.current?.chart) {\n      createChart(props);\n      renderChart();\n      bindEventsToChart(chartContext.current.chart, props, null, CHART_EVENTS);\n      chartContext.current = {\n        ...chartContext.current,\n        isChildrenUpdated: false\n      };\n      eventsBinded.current = props;\n      return;\n    }\n\n    if (hasSpec) {\n      if (!isEqual(eventsBinded.current.spec, props.spec, { skipFunction: skipFunctionDiff })) {\n        eventsBinded.current = props;\n        if (useSyncRender) {\n          chartContext.current.chart.updateSpecSync(parseSpec(props), undefined, {\n            morph: false,\n            enableExitAnimation: false\n          });\n          handleChartRender();\n        } else {\n          // eslint-disable-next-line promise/catch-or-return\n          chartContext.current.chart\n            .updateSpec(parseSpec(props), undefined, { morph: false, enableExitAnimation: false }) // morph临时关掉\n            .then(handleChartRender);\n        }\n      }\n      return;\n    }\n\n    const newSpec = pickWithout(props, notSpecKeys);\n\n    if (\n      !isEqual(newSpec, prevSpec.current, { skipFunction: skipFunctionDiff }) ||\n      chartContext.current.isChildrenUpdated\n    ) {\n      prevSpec.current = newSpec;\n\n      if (useSyncRender) {\n        chartContext.current.chart.updateSpecSync(parseSpec(props), undefined, {\n          morph: false,\n          enableExitAnimation: false\n        });\n        handleChartRender();\n      } else {\n        // eslint-disable-next-line promise/catch-or-return\n        chartContext.current.chart\n          .updateSpec(parseSpec(props), undefined, { morph: false, enableExitAnimation: false }) // morph临时关掉\n          .then(handleChartRender);\n      }\n    }\n    chartContext.current = {\n      ...chartContext.current,\n      isChildrenUpdated: false\n    };\n  }, [props]);\n\n  useEffect(() => {\n    return () => {\n      if (chartContext) {\n        if (chartContext.current.chart) {\n          chartContext.current.chart.release();\n        }\n        chartContext.current = null;\n      }\n      isUnmount.current = true;\n    };\n  }, []);\n\n  return (\n    <RootChartContext.Provider value={chartContext.current}>\n      <ViewContext.Provider value={view}>\n        {toArray(props.children).map((child, index) => {\n          return (\n            <React.Fragment key={(child as any)?.props?.id ?? (child as any)?.id ?? `child-${index}`}>\n              {React.cloneElement(child as IMarkElement, {\n                updateId: updateId\n              })}\n            </React.Fragment>\n          );\n        })}\n      </ViewContext.Provider>\n    </RootChartContext.Provider>\n  );\n});\n\nexport const createChart = <T extends Props>(\n  componentName: string,\n  defaultProps?: Partial<T>,\n  callback?: (props: T, defaultProps?: Partial<T>) => T\n) => {\n  const Com = withContainer<ContainerProps, T>(BaseChart as any, componentName, (props: T) => {\n    if (callback) {\n      return callback(props, defaultProps);\n    }\n\n    if (defaultProps) {\n      return Object.assign(props, defaultProps);\n    }\n    return props;\n  });\n  Com.displayName = componentName;\n  return Com;\n};\n"]}